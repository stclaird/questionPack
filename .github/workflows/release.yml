name: Create Release

on:
    push:
        tags:
            - "v*" # Triggers on version tags like v1.0.0, v2.1.3, etc.
    workflow_dispatch: # Allows manual triggering
        inputs:
            tag_name:
                description: "Tag name for the release (e.g., v1.0.0)"
                required: true
                default: "v1.0.0"
            release_name:
                description: "Name of the release"
                required: true
                default: "Release v1.0.0"
            release_body:
                description: "Release notes/description"
                required: false
                default: "Latest release with new features and improvements"
            prerelease:
                description: "Mark as pre-release"
                required: false
                default: false
                type: boolean

jobs:
    create-release:
        runs-on: ubuntu-latest
        permissions:
            contents: write # Required to create releases

        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0 # Fetch all history for all tags and branches

            - name: Set up variables
              id: vars
              run: |
                  if [ "${{ github.event_name }}" == "push" ]; then
                    # Extract tag from push event
                    TAG_NAME=${GITHUB_REF#refs/tags/}
                    RELEASE_NAME="Release $TAG_NAME"
                    echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
                    echo "release_name=$RELEASE_NAME" >> $GITHUB_OUTPUT
                    echo "prerelease=false" >> $GITHUB_OUTPUT
                  else
                    # Use inputs from manual trigger
                    echo "tag_name=${{ github.event.inputs.tag_name }}" >> $GITHUB_OUTPUT
                    echo "release_name=${{ github.event.inputs.release_name }}" >> $GITHUB_OUTPUT
                    echo "prerelease=${{ github.event.inputs.prerelease }}" >> $GITHUB_OUTPUT
                  fi

            - name: Create or update tag (for manual triggers)
              if: github.event_name == 'workflow_dispatch'
              run: |
                  git config user.name "github-actions[bot]"
                  git config user.email "github-actions[bot]@users.noreply.github.com"
                  git tag -a "${{ steps.vars.outputs.tag_name }}" -m "${{ steps.vars.outputs.release_name }}"
                  git push origin "${{ steps.vars.outputs.tag_name }}"

            - name: Generate release notes
              id: generate_notes
              run: |
                  if [ "${{ github.event_name }}" == "push" ]; then
                    # For tag pushes, generate changelog from commits
                    PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
                    if [ -n "$PREVIOUS_TAG" ]; then
                      echo "## What's Changed" > release_notes.md
                      echo "" >> release_notes.md
                      git log --pretty=format:"- %s (%h)" ${PREVIOUS_TAG}..HEAD >> release_notes.md
                    else
                      echo "## Initial Release" > release_notes.md
                      echo "" >> release_notes.md
                      echo "This is the first release of the project." >> release_notes.md
                    fi
                  else
                    # For manual triggers, use provided input or default
                    BODY="${{ github.event.inputs.release_body }}"
                    if [ -z "$BODY" ]; then
                      BODY="Latest release with new features and improvements"
                    fi
                    echo "$BODY" > release_notes.md
                  fi

                  # Read the content and set as output
                  {
                    echo 'RELEASE_BODY<<EOF'
                    cat release_notes.md
                    echo EOF
                  } >> $GITHUB_OUTPUT

            - name: Create GitHub Release
              id: create_release
              uses: actions/create-release@v1
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              with:
                  tag_name: ${{ steps.vars.outputs.tag_name }}
                  release_name: ${{ steps.vars.outputs.release_name }}
                  body: ${{ steps.generate_notes.outputs.RELEASE_BODY }}
                  draft: false
                  prerelease: ${{ steps.vars.outputs.prerelease }}

            - name: Update latest tag
              if: steps.vars.outputs.prerelease == 'false'
              run: |
                  # Delete existing latest tag if it exists
                  git push origin :refs/tags/latest || true
                  git tag -d latest || true

                  # Create new latest tag pointing to current commit
                  git tag latest
                  git push origin latest

            - name: Archive project files
              run: |
                  # Create temporary directory for archives to avoid conflicts
                  mkdir -p ./archives

                  # Create file list excluding problematic paths
                  find . -type f \
                    ! -path "./.git/*" \
                    ! -path "./.github/*" \
                    ! -path "./archives/*" \
                    ! -name "*.zip" \
                    ! -name "*.tar.gz" \
                    ! -name "release_notes.md" > ./archives/file_list.txt

                  # Create zip archive using file list
                  zip -r "./archives/questionPack-${{ steps.vars.outputs.tag_name }}.zip" . \
                    -x ".git/*" ".github/*" "archives/*" "*.zip" "*.tar.gz" "release_notes.md"

                  # Create tar.gz archive from file list to avoid the "file changed" error
                  tar -czf "./archives/questionPack-${{ steps.vars.outputs.tag_name }}.tar.gz" \
                    --exclude=".git" \
                    --exclude=".github" \
                    --exclude="archives" \
                    --exclude="*.zip" \
                    --exclude="*.tar.gz" \
                    --exclude="release_notes.md" \
                    .

                  # Move archives to root and create latest copies
                  mv "./archives/questionPack-${{ steps.vars.outputs.tag_name }}.zip" .
                  mv "./archives/questionPack-${{ steps.vars.outputs.tag_name }}.tar.gz" .
                  cp "questionPack-${{ steps.vars.outputs.tag_name }}.zip" "questionPack-latest.zip"
                  cp "questionPack-${{ steps.vars.outputs.tag_name }}.tar.gz" "questionPack-latest.tar.gz"

                  # Clean up temporary directory
                  rm -rf ./archives

            - name: Upload Release Assets
              uses: actions/upload-release-asset@v1
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              with:
                  upload_url: ${{ steps.create_release.outputs.upload_url }}
                  asset_path: ./questionPack-${{ steps.vars.outputs.tag_name }}.zip
                  asset_name: questionPack-${{ steps.vars.outputs.tag_name }}.zip
                  asset_content_type: application/zip

            - name: Upload Release Assets (tar.gz)
              uses: actions/upload-release-asset@v1
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              with:
                  upload_url: ${{ steps.create_release.outputs.upload_url }}
                  asset_path: ./questionPack-${{ steps.vars.outputs.tag_name }}.tar.gz
                  asset_name: questionPack-${{ steps.vars.outputs.tag_name }}.tar.gz
                  asset_content_type: application/gzip

            - name: Upload Latest Release Assets (zip)
              if: steps.vars.outputs.prerelease == 'false'
              uses: actions/upload-release-asset@v1
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              with:
                  upload_url: ${{ steps.create_release.outputs.upload_url }}
                  asset_path: ./questionPack-latest.zip
                  asset_name: questionPack-latest.zip
                  asset_content_type: application/zip

            - name: Upload Latest Release Assets (tar.gz)
              if: steps.vars.outputs.prerelease == 'false'
              uses: actions/upload-release-asset@v1
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              with:
                  upload_url: ${{ steps.create_release.outputs.upload_url }}
                  asset_path: ./questionPack-latest.tar.gz
                  asset_name: questionPack-latest.tar.gz
                  asset_content_type: application/gzip
